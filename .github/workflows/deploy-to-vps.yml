name: Deploy - to VPS via GHCR

on:
  workflow_call:
    secrets:
      SSH_PRIVATE_KEY:
        required: true
      VPS_HOST:
        required: true
      VPS_USER:
        required: true
      GHCR_TOKEN:
        required: true
      GHCR_USERNAME:
        required: true
    inputs:
      IMAGE_NAME:
        required: true
        type: string
      COMPOSE_PATH:
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üîê Setup SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: üöÄ SSH to VPS and Deploy
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << EOF
            echo "Logging into GHCR..."
            echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ secrets.GHCR_USERNAME }} --password-stdin

            echo "Pulling new image: ghcr.io/${{ secrets.GHCR_USERNAME }}/${{ inputs.IMAGE_NAME }}:latest"
            docker pull ghcr.io/${{ secrets.GHCR_USERNAME }}/${{ inputs.IMAGE_NAME }}:latest

            echo "   Restarting service with Docker Compose"
            docker compose -f ${{ inputs.COMPOSE_PATH }} up -d

            echo " Cleaning up old images..."
            docker image prune -f
          EOF
