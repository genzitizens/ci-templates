name: Deploy - to VPS via GHCR

on:
  workflow_call:
    secrets:
      SSH_PRIVATE_KEY:
        required: true
      VPS_HOST:
        required: true
      VPS_USER:
        required: true
      GHCR_TOKEN:
        required: true
      GHCR_USERNAME:
        required: true
      DISCORD_WEBHOOK:
        required: true
    inputs:
      IMAGE_NAME:
        required: true
        type: string
      COMPOSE_PATH:
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üîê Setup SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: üöÄ SSH to VPS and Deploy
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            set -e

            echo "Logging into GHCR..."
            echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ secrets.GHCR_USERNAME }} --password-stdin

            echo "Pulling new image: ghcr.io/${{ secrets.GHCR_USERNAME }}/${{ inputs.IMAGE_NAME }}:latest"
            docker pull ghcr.io/${{ secrets.GHCR_USERNAME }}/${{ inputs.IMAGE_NAME }}:latest

            echo "Restarting service with Docker Compose"
            docker compose -f ${{ inputs.COMPOSE_PATH }} up -d

            echo "Cleaning up old images..."
            docker image prune -f
          EOF

      - name: ‚úÖ Notify Discord on Success
        if: success()
        uses: Ilshidur/action-discord@master
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          message: |
            ‚úÖ **Deployment SUCCEEDED** on `${{ github.repository }}`
            üß± Image: `${{ inputs.IMAGE_NAME }}`
            üë§ Triggered by: `${{ github.actor }}`
            üîó [View Workflow Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

      - name: ‚ùå Notify Discord on Failure
        if: failure()
        uses: Ilshidur/action-discord@master
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          message: |
            üî• **Deployment FAILED** on `${{ github.repository }}`
            üß± Image: `${{ inputs.IMAGE_NAME }}`
            üë§ Triggered by: `${{ github.actor }}`
            üö® Job: `${{ github.job }}`
            üîó [View Workflow Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
